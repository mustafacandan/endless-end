{% extends "base.html" %}
{% block body %}
    <div class="mt-5">
    </div>
    <div class="warpper" style="width: 800px; margin: auto">

        <form id="editorForm" action="./next" method="post" id="identifier">
            
            {{ form.csrf_token }}

            <form class="dropdown-menu p-4">
                {{ form.text.label }}
                <div class="form-group" id="editor">
                    {{ form.text(class="form-control", id="hiddenArea", style="display:none") }}
                    </div>
                </form>
                <br>
                
            </form>
            
            <div class="mt-3"></div>
            <button id="next" type="button" class="btn btn-light">Next</button>
            <button id="end" type="button" class="btn btn-light">End</button>
            <button id="path" type="button" class="btn btn-light">Add Path</button>
            <button id="connect" type="button" class="btn btn-light">Connect</button>

        </div>

    </div>
    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Initialize Quill editor -->
    <script>
        var toolbarOptions = [
        ['bold', 'italic', 'underline'],        // toggled buttons
        ['blockquote', 'code-block'],

        [{ 'color': [] }],          // dropdown with defaults from theme
        
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
        [{ 'align': [] }],

        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

        [{ 'font': [] }],
        [ 'image'],
        ['clean']                                         // remove formatting button
        ];

        var quill = new Quill('#editor', {
        modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });
        
        $(document).ready(function() {
            $("#next").click(function(){
                // $("#hiddenArea").val($("#editor").html());
                // $.post( "/next", $( "#editorForm" ).serialize() );

                $.ajax({
                url: '/compose/new',
                type: 'POST',
                data: { text: quill.container.firstChild.innerHTML, title: $("#title").val() },
                success: function(result) {
                    console.log(result)
                    window.location.href = '/compose/'+result.path_id;
                },
                });
            }); 

            $(document).keydown(function(e) {

            var key = undefined;
            var possible = [ e.key, e.keyIdentifier, e.keyCode, e.which ];

            while (key === undefined && possible.length > 0)
            {
                key = possible.pop();
            }

            if (key && (key == '115' || key == '83' ) && (e.ctrlKey || e.metaKey) && !(e.altKey))
            {
                e.preventDefault();
                $.ajax({
                url: 'next',
                type: 'POST',
                data: { text: $("#editor").html() },
                success: function(result) {
                    alert("Saved");
                },
                });
                return false;
            }
            return true;
            }); 
        });
    </script>
{% endblock %}
